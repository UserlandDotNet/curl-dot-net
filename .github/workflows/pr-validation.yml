name: PR Validation

on:
  pull_request:
    branches: [ master, main ]
    types: [ opened, synchronize, reopened ]

jobs:
  validate-scripts:
    name: Validate Scripts
    runs-on: ubuntu-latest

    steps:
    - name: Checkout PR branch
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Make scripts executable
      run: |
        chmod +x scripts/*.sh
        chmod +x *.sh 2>/dev/null || true

    - name: Validate all scripts syntax
      run: |
        echo "üß™ Validating shell script syntax..."
        FAILED=0
        for script in scripts/*.sh *.sh; do
          if [ -f "$script" ]; then
            echo "Checking $script..."
            bash -n "$script"
            if [ $? -ne 0 ]; then
              echo "‚ùå Syntax error in $script"
              FAILED=1
            fi
          fi
        done

        if [ $FAILED -eq 1 ]; then
          echo "‚ùå Script validation failed!"
          exit 1
        fi
        echo "‚úÖ All scripts have valid syntax"

  build-and-test:
    name: Build and Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
      fail-fast: false

    steps:
    - name: Checkout PR branch
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Make scripts executable (Unix)
      if: runner.os != 'Windows'
      run: chmod +x scripts/*.sh

    - name: Build and test (Unix)
      if: runner.os != 'Windows'
      run: ./scripts/build-and-test.sh

    - name: Build and test (Windows)
      if: runner.os == 'Windows'
      run: |
        dotnet restore
        dotnet build --configuration Release
        dotnet test --configuration Release

  documentation-check:
    name: Documentation Build Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout PR branch
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Install DocFX
      run: dotnet tool install -g docfx

    - name: Make scripts executable
      run: chmod +x scripts/*.sh

    - name: Test documentation build
      run: |
        echo "üìö Testing documentation build..."
        ./scripts/build-docs.sh

        if [ ! -d "docs/_site" ]; then
          echo "‚ùå Documentation build failed - no output"
          exit 1
        fi

        HTML_COUNT=$(find docs/_site -name "*.html" | wc -l)
        echo "‚úÖ Documentation build successful: $HTML_COUNT HTML files"

  pr-summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [validate-scripts, build-and-test, documentation-check]
    if: always()

    steps:
    - name: PR validation summary
      run: |
        echo "## PR Validation Summary"
        echo ""

        if [ "${{ needs.validate-scripts.result }}" == "success" ]; then
          echo "‚úÖ Script validation: Passed"
        else
          echo "‚ùå Script validation: Failed"
        fi

        if [ "${{ needs.build-and-test.result }}" == "success" ]; then
          echo "‚úÖ Build and test: Passed"
        else
          echo "‚ùå Build and test: Failed"
        fi

        if [ "${{ needs.documentation-check.result }}" == "success" ]; then
          echo "‚úÖ Documentation: Builds successfully"
        else
          echo "‚ùå Documentation: Build failed"
        fi

        echo ""
        echo "### Ready to merge?"
        if [ "${{ needs.validate-scripts.result }}" == "success" ] && \
           [ "${{ needs.build-and-test.result }}" == "success" ] && \
           [ "${{ needs.documentation-check.result }}" == "success" ]; then
          echo "‚úÖ All checks passed! This PR is ready to merge."
        else
          echo "‚ùå Some checks failed. Please fix the issues before merging."
          exit 1
        fi