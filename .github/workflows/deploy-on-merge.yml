name: Deploy on Merge to Master

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write
  packages: write

jobs:
  deploy-documentation:
    name: Deploy Documentation to GitHub Pages
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'

    steps:
    - name: Checkout master branch
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Install DocFX
      run: dotnet tool install -g docfx

    - name: Make scripts executable
      run: chmod +x scripts/*.sh

    - name: Build documentation
      run: |
        echo "üìö Building documentation for deployment..."
        ./scripts/build-docs.sh

    - name: Verify documentation output
      run: |
        if [ ! -d "docs/_site" ]; then
          echo "‚ùå Documentation build failed"
          exit 1
        fi
        HTML_COUNT=$(find docs/_site -name "*.html" | wc -l)
        echo "‚úÖ Built $HTML_COUNT HTML files"

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs/_site
        publish_branch: gh-pages
        force_orphan: true
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
        commit_message: |
          Deploy documentation from ${{ github.sha }}

          Triggered by: merge to master
          Commit: ${{ github.event.head_commit.message }}
        enable_jekyll: false

  check-for-release:
    name: Check if Release Needed
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check_version.outputs.should_release }}
      version: ${{ steps.check_version.outputs.version }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check version in project file
      id: check_version
      run: |
        # Extract version from .csproj
        VERSION=$(grep '<Version>' src/CurlDotNet/CurlDotNet.csproj | sed 's/.*<Version>\(.*\)<\/Version>.*/\1/')
        echo "version=$VERSION" >> $GITHUB_OUTPUT

        # Check if tag exists
        if git rev-parse "v$VERSION" >/dev/null 2>&1; then
          echo "Tag v$VERSION already exists"
          echo "should_release=false" >> $GITHUB_OUTPUT
        else
          echo "Tag v$VERSION does not exist - will create release"
          echo "should_release=true" >> $GITHUB_OUTPUT
        fi

  release-nuget:
    name: Release to NuGet
    runs-on: ubuntu-latest
    needs: check-for-release
    if: needs.check-for-release.outputs.should_release == 'true'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Make scripts executable
      run: chmod +x scripts/*.sh

    - name: Build and pack NuGet
      run: |
        echo "üì¶ Building NuGet package version ${{ needs.check-for-release.outputs.version }}..."
        ./scripts/pack-nuget.sh

    - name: Publish to NuGet
      env:
        NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
      run: |
        if [ -z "$NUGET_API_KEY" ]; then
          echo "‚ö†Ô∏è  NUGET_API_KEY not configured - skipping NuGet publish"
          echo "   Configure it in Settings ‚Üí Secrets ‚Üí Actions"
          exit 0
        fi

        echo "üì§ Publishing to NuGet.org..."
        dotnet nuget push ./nupkg/*.nupkg \
          --api-key $NUGET_API_KEY \
          --source https://api.nuget.org/v3/index.json \
          --skip-duplicate

    - name: Create GitHub release tag
      if: success()
      run: |
        VERSION="${{ needs.check-for-release.outputs.version }}"
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag -a "v$VERSION" -m "Release version $VERSION"
        git push origin "v$VERSION"

    - name: Create GitHub release
      if: success()
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ needs.check-for-release.outputs.version }}
        files: nupkg/*.nupkg
        generate_release_notes: true
        draft: false