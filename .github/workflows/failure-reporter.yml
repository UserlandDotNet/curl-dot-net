name: Workflow Failure Reporter

on:
  workflow_run:
    workflows: ["PR Validation", "Deploy on Merge to Master", "CI Build & Test"]
    types: [completed]

permissions:
  contents: write
  issues: write

jobs:
  report-failure:
    name: Report Workflow Failure
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: dev  # Write to dev branch

    - name: Create failure report
      run: |
        # Create reports directory
        mkdir -p .workflow-reports

        # Generate timestamp and filename
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
        SAFE_NAME=$(echo "$WORKFLOW_NAME" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
        REPORT_FILE=".workflow-reports/failure_${SAFE_NAME}_${TIMESTAMP}.md"

        # Create the failure report
        cat > "$REPORT_FILE" << 'EOF'
        # Workflow Failure Report

        ## Summary
        - **Workflow**: ${{ github.event.workflow_run.name }}
        - **Run ID**: ${{ github.event.workflow_run.id }}
        - **Run Number**: ${{ github.event.workflow_run.run_number }}
        - **Triggered by**: ${{ github.event.workflow_run.event }}
        - **Failed at**: ${{ github.event.workflow_run.updated_at }}
        - **Branch**: ${{ github.event.workflow_run.head_branch }}
        - **Commit**: ${{ github.event.workflow_run.head_sha }}
        - **Commit message**: ${{ github.event.workflow_run.head_commit.message }}

        ## Direct Links
        - [View failed workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }})
        - [View logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/attempts/1)

        ## Failure Context

        ### What was attempted
        The workflow `${{ github.event.workflow_run.name }}` attempted to run but failed.

        ### Common failure reasons to check:
        1. **Script syntax errors** - Check shell scripts for bash syntax issues
        2. **Missing dependencies** - Ensure all tools (docfx, dotnet) are installed
        3. **File permissions** - Scripts might not be executable
        4. **Path issues** - Files or directories not found
        5. **Test failures** - Unit tests or integration tests failing
        6. **Documentation build errors** - DocFX configuration issues
        7. **Network issues** - Package restore or API calls timing out

        ### Diagnostic commands to run locally:
        ```bash
        # Test all scripts
        ./test-all-scripts.sh

        # Check specific workflow scripts
        chmod +x scripts/*.sh
        bash -n scripts/*.sh  # Syntax check

        # Test builds
        dotnet restore
        dotnet build
        dotnet test

        # Test documentation
        cd build/docfx && docfx build
        ```

        ### AI Instructions for Fixing
        1. Read this failure report
        2. Check the workflow file: `.github/workflows/${{ github.event.workflow_run.path }}`
        3. Look for recent changes that might have broken it
        4. Run the diagnostic commands above locally
        5. Fix identified issues
        6. Test the fix locally
        7. Commit to dev branch and create new PR

        ## Raw Event Data
        ```json
        ${{ toJSON(github.event.workflow_run) }}
        ```

        ---
        *This report was automatically generated to help diagnose and fix the workflow failure.*
        EOF

        echo "ðŸ“ Failure report created: $REPORT_FILE"

    - name: Commit failure report
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        git add .workflow-reports/
        git commit -m "ðŸš¨ Workflow failure report: ${{ github.event.workflow_run.name }}

        Workflow failed at: ${{ github.event.workflow_run.updated_at }}
        Run ID: ${{ github.event.workflow_run.id }}

        This automated report helps diagnose and fix the failure.
        Check .workflow-reports/ for details."

        git push origin dev

    - name: Create issue for critical failures
      if: contains(github.event.workflow_run.name, 'Deploy') || contains(github.event.workflow_run.name, 'Release')
      uses: actions/github-script@v7
      with:
        script: |
          const title = `ðŸš¨ Critical Workflow Failure: ${context.payload.workflow_run.name}`;
          const body = `## Automated Failure Alert

          A critical workflow has failed and needs immediate attention.

          **Workflow**: ${context.payload.workflow_run.name}
          **Run**: [#${context.payload.workflow_run.run_number}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.payload.workflow_run.id})
          **Branch**: ${context.payload.workflow_run.head_branch}
          **Triggered by**: ${context.payload.workflow_run.event}

          ### Action Required
          1. Check the failure report in \`.workflow-reports/\`
          2. Review the [workflow logs](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.payload.workflow_run.id})
          3. Fix the issue in the dev branch
          4. Create a new PR to test the fix

          ### Quick Diagnosis
          \`\`\`bash
          # Pull latest dev branch with failure report
          git checkout dev
          git pull origin dev

          # Check the failure report
          ls -la .workflow-reports/

          # Run local tests
          ./test-all-scripts.sh
          \`\`\`

          ---
          *This issue was automatically created by the failure reporter workflow.*
          `;

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['bug', 'ci-failure', 'automated']
          });